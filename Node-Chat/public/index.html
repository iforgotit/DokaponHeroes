<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

  <title>Dokapon Heroes</title>

  <!-- Bootstrap core CSS -->
  <link href="../../assets/css/bootstrap.min.css" rel="stylesheet">

</head>

<body onload="checkAccount()">
  <div class="container">
    <form class="form-signin col-md-6" onsubmit="login()">
      <table style="width:100%">
        <tr>
          <td>
            <h1 class="form-signin-heading" id="title">Who dis?</h1>
          </td>
          <td align="right">
            <button id="btnAccount" type="button" class="btn btn-lg btn-primary" onclick="newAccount()">I'm New</button>
          </td>
        </tr>
      </table>
      <div>
        <!--Email field-->
        <label for="txtEmail" class="sr-only">Email address</label>
        <input type="email" id="txtEmail" class="form-control" placeholder="Email address" required autofocus><br>
        <!--Display name field-->
        <label for="txtPassword" class="sr-only">Display Name</label>
        <input type="password" id="txtPassword" class="form-control" placeholder="Password" required><br>
        <!--login button-->
        <input id="btnLogin" type="button" class="btn btn-lg btn-primary col-md-3" onclick="login()" value="LET'S GO">
      </div>
    </form>
  </div><br>
  <div class="container col-md-2"></div>
  <div class="col-md-4 alert alert-danger" id="z" role="alert" hidden>

  </div>

  <!-- /container -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    var socket = io();
    //On successful login return user information and set into the session storage
    socket.on('userJSON', function (msg) {
      //Set session storage
      sessionStorage.setItem('id', msg._id);
      sessionStorage.setItem('dname', msg.dname);
      sessionStorage.setItem('email', msg.email);
      //moves user to the landing page
      window.location.href = 'landing.html';
    });
    socket.on('unsuccessful', function (msg) {
      //On failed authentication
      document.getElementById("z").hidden = false;
      document.getElementById("z").innerHTML =
        '<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span><br>Incorrect username or password';
    });
  </script>
  <script>
    //executed on clicking the login button
    function login() {
      event.preventDefault();

      document.getElementById("btnLogin").disabled = true;
      document.getElementById("z").hidden = true;

      var email = document.getElementById("txtEmail");
      var password = document.getElementById("txtPassword");

      if (!email.validity.valid || !password.validity.valid) {
        document.getElementById("z").hidden = false;
        document.getElementById("z").innerHTML =
          '<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span><br>';

        if (!email.validity.valid) {
          document.getElementById("z").innerHTML = document.getElementById("z").innerHTML +
            "Invalid E-mail Address <br>";
          email.classList.add('has-error');
        }
        if (!password.validity.valid) {
          document.getElementById("z").innerHTML = document.getElementById("z").innerHTML +
            "Password cannot be empty <br>";
          password.classList.add('has-error');
        }

        document.getElementById("btnLogin").disabled = false;
      } else {
        var JSONuser = {
          "email": email.value.toLowerCase(),
          "password": password.value
        }
        //sends the object to the server
        socket.emit('authenticate', JSONuser);
        document.getElementById("btnLogin").disabled = false;
      }

    }

    function checkAccount() {
      var query = window.location.search.substring(1);
      var vars = query.split("&");
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        if (pair[0]) {
          document.getElementById("title").innerHTML = "Successfully Created Account";
          document.getElementById("btnAccount").style.visibility = 'hidden';
        }
      }

      if (sessionStorage.id) {
        window.location.href = 'landing.html';
        return false;
      }
    }

    function newAccount() {
      window.location.href = 'createAccount.html';
    }
  </script>
</body>

</html>