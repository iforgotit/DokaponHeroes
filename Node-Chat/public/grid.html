<!doctype html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <title>Dokapon Heroes</title>

    <!-- Bootstrap core CSS -->
    <link href="../../assets/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://code.createjs.com/easeljs-0.8.2.min.js"></script>
    <script src="https://code.createjs.com/tweenjs-0.6.2.min.js"></script>
    <script src="https://code.createjs.com/preloadjs-0.6.2.min.js"></script>
</head>

<body onload="init();">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-10">
                <canvas id="battlefield" width="500"></canvas>
                <p id="x"></p>
                <p id="y"></p>
                <p id="z"></p>
            </div>
            <div class="col-sm-2">
                Turn Timer:
                <p id="time"></p>
                <input id="btnReturn" type="button" class="btn btn-lg btn-primary" style="width:100%; white-space:normal;" onclick="landing()"
                    value="Return to Main Lobby">
            </div>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var queue;
        var stage = new createjs.Stage("battlefield");
        var bfgridxy;
        var socket = io('/ingame');
        var players;

        function setbfgridxy(size) {
            bfgridxy = size;
            var canvas = document.getElementById("battlefield");
            if (size > 5) {
                canvas.height = (size * 100)+20;
                canvas.width = (size * 100)+20;
            } else {
                canvas.height = 520;
                canvas.width = 520;
            }

            loadAsset();
            queue.load();
        }

        function getbfgridxy() {
            return bfgridxy;
        }

        function setPlayers(playerObject) {
            players = playerObject;
        }

        function getPlayers() {
            return players;
        }

        function stop() {
            if (preload != null) {
                preload.close();
            }
        }

        socket.on('gameJSON', function (gameJSON) {
            setbfgridxy(gameJSON.size);
            setPlayers(gameJSON.players);
        })



        function landing() {
            window.location.href = 'landing.html';
        }


        function init() {
            if (sessionStorage.id == undefined) {
                window.location.href = 'index.html';
                return false;
            }

            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[1]) {
                    socket.emit('gameID', pair[1], sessionStorage.id)
                }
            }

            distractor();

            createjs.Ticker.setFPS(30);
            createjs.Ticker.on("tick", handleTick);

            queue = new createjs.LoadQueue(false);

            queue.on("complete", handleComplete);
            queue.on("error", handleError);
        }

        function handleError(event) {
            var item = event.data;
            var div = document.getElementById("z");
            if (div != null) {
                div.innerHTML = "<label>Error " + (item.id == "NoFileHere.png" ? ":)" : ":(") + "</label>";
                div.className = "gridBox error";
            }
        }

        function distractor() {
            var ldRect = new createjs.Shape();
            var ldCircle = new createjs.Shape();

            var ldText = new createjs.Text("Loading...", "bold 70px Arial", "#ff7700");
            ldText.x = 25;
            ldText.y = 50;

            ldRect.graphics.beginFill("#2b3e50").drawRect(0, 0, 500, 500);
            ldRect.x = 50;
            ldRect.y = 0;
            createjs.Tween.get(ldRect, {
                    loop: true
                })
                .to({
                    x: 400
                }, 3000, createjs.Ease.getPowInOut(4))
                .to({
                    x: 50
                }, 3000, createjs.Ease.getPowInOut(4));

            ldCircle.graphics.beginFill("Crimson").drawCircle(0, 0, 40);
            ldCircle.x = 50;
            ldCircle.y = 90;
            createjs.Tween.get(ldCircle, {
                    loop: true
                })
                .to({
                    x: 400
                }, 3000, createjs.Ease.getPowInOut(4))
                .to({
                    x: 50
                }, 3000, createjs.Ease.getPowInOut(4));

            stage.addChild(ldText);
            stage.addChild(ldRect);
            stage.addChild(ldCircle);
            stage.update();
        }

        function loadAsset() {
            queue.loadManifest([{
                id: "grass",
                src: "../../assets/img/grass.png"
            }, {
                id: "mightData",
                src: "../../assets/sprites/might.json",
                type: "spritesheet",
                crossOrigin: true
            }, {
                id: "magicData",
                src: "../../assets/sprites/magic.json",
                type: "spritesheet",
                crossOrigin: true
            }, {
                id: "cunningData",
                src: "../../assets/sprites/cunning.json",
                type: "spritesheet",
                crossOrigin: true
            }, {
                id: "brawlData",
                src: "../../assets/sprites/brawl.json",
                type: "spritesheet",
                crossOrigin: true
            }]);
        }

        function handleTick() {
            stage.update();
        }

        function handleComplete() {
            var turnSelected = undefined;
            var playerLocation = new Object();

            stage.removeAllChildren();

            document.getElementById("z").innerHTML = "";

            createjs.Touch.enable(stage);
            stage.enableMouseOver(10);

            var grass = queue.getResult("grass");
            var mightSprite = queue.getResult("mightData");
            var magicSprite = queue.getResult("magicData");
            var cunningSprite = queue.getResult("cunningData");
            var brawlSprite = queue.getResult("brawlData");

            // The good stuff
            for (var y = 0; y < (getbfgridxy()); y++) {
                for (var x = 0; x < (getbfgridxy()); x++) {
                    var grid = new createjs.Shape();
                    grid.x = x * 100;
                    grid.y = y * 100;
                    grid.overStroke = "#00FF00";
                    grid.outStroke = "#000000";
                    grid.disableStroke = "#FF0000";
                    grid.clickStroke = "#3281FF";
                    grid.on("mouseover", handleMouseEvent);
                    grid.on("mouseout", handleMouseEvent);
                    grid.on("click", handleMouseEvent);
                    grid.name = {
                        'x': x,
                        'y': y
                    };
                    grid.graphics.beginStroke(grid.outStroke).beginBitmapFill(grass).setStrokeStyle(2).drawRect(
                        0, 0,
                        98, 98).endStroke();
                    stage.addChild(grid);
                }
            }

            for (var i = 0; i <= (getPlayers().length - 1); i++) {
                var heroData = getPlayers()[i];
                if (heroData.pClass != "Observer") {
                    var spriteSheet;
                    switch (heroData.pClass) {
                        case "Magii":
                            spriteSheet = magicSprite;
                            break;
                        case "Warrior":
                            spriteSheet = mightSprite;
                            break;
                        case "Rogue":
                            spriteSheet = cunningSprite;
                            break;
                    }
                    var hero = new createjs.Sprite(spriteSheet, "stand");
                    hero.x = (heroData.startX * 100) + 50;
                    hero.y = (heroData.startY * 100) + 95;
                    hero.type = "hero";
                    hero.name = heroData.pID;

                    playerLocation[heroData.pID] = {
                        x: heroData.startX,
                        y: heroData.startY
                    }

                    var nameplate = new createjs.Text(heroData.dName, "12px Arial", "#ff7700");
                    nameplate.x = (heroData.startX * 100) + 25;
                    nameplate.y = (heroData.startY * 100) + 100;
                    nameplate.name = "n" + heroData.pID;

                    stage.addChild(nameplate);
                    stage.addChild(hero);
                }

            }

            stage.update();

            function handleMouseEvent(event) {
                var target = event.target;
                if (event.type == "mouseover" && turnSelected == undefined) {
                    target.graphics.beginStroke(target.overStroke).setStrokeStyle(2).drawRect(0, 0, 98, 98).endStroke();
                } else if (event.type == "mouseout" && turnSelected == undefined) {
                    target.graphics.beginStroke(target.outStroke).setStrokeStyle(2).drawRect(0, 0, 98, 98).endStroke();
                } else if (event.type == "click" && turnSelected == undefined) {
                    target.graphics.beginStroke(target.clickStroke).setStrokeStyle(2).drawRect(0, 0, 98, 98).endStroke();
                    turnSelected = target;
                    var turnJSON = {
                        "playerID": sessionStorage.id,
                        "stageX": event.stageX,
                        "target": target.name
                    }
                    socket.emit('turnData', turnJSON);
                }
            }

            socket.on('endTurn', function (endTurnData) {

                for (let i = 0; i <= (endTurnData.length - 1); i++) {
                    let target = endTurnData[i].target;
                    if (turnSelected != undefined) {
                        turnSelected.graphics.beginStroke(turnSelected.outStroke).setStrokeStyle(2).drawRect(0,
                            0,
                            98, 98).endStroke();
                        turnSelected = undefined;
                    }
                    let eachHero = stage.getChildByName(endTurnData[i].playerID);
                    let eachNameplate = stage.getChildByName("n" + endTurnData[i].playerID);
                    if (eachHero.x > endTurnData[i].stageX) {
                        eachHero.scaleX = -1;
                        eachHero.gotoAndPlay("walk");
                    } else {
                        eachHero.gotoAndPlay("walk");
                        eachHero.scaleX = 1;
                    }

                    createjs.Tween.get(eachHero, {
                            loop: false
                        })
                        .to({
                            x: (target.x * 100) + 50,
                            y: (target.y * 100) + 95
                        }, 1000).call(function () {
                            eachHero.gotoAndPlay("stand");
                        });

                    createjs.Tween.get(eachNameplate, {
                        loop: false
                    }).to({
                        x: (target.x * 100) + 25,
                        y: (target.y * 100) + 100
                    }, 1000)

                    let pID = endTurnData[i].playerID;

                    playerLocation[pID] = {
                        x: target.x,
                        y: target.y
                    }
                }

                document.getElementById("y").innerHTML = "";

                for (let n = 0; n <= (Object.keys(playerLocation).length - 1); n++) {
                    let pOX = Object.keys(playerLocation)[n];
                    let pX = playerLocation[pOX];
                    let eachHero = stage.getChildByName(pOX);
                    let eachNameplate = stage.getChildByName("n" + pOX);
                    for (let i = 0; i <= (Object.keys(playerLocation).length - 1); i++) {

                        if (i != n) {
                            let pOY = Object.keys(playerLocation)[i];
                            let pY = playerLocation[pOY];
                            if (pX.x == pY.x && pX.y == pY.y) {
                                playerLocation[pOX].inCombat = 1;
                            };
                        };
                    }
                    
                    if (playerLocation[pOX].inCombat == 1) {
                        if (sessionStorage.id == pOX) {
                            document.getElementById("z").innerHTML += "you are in a fight!";
                        }
                        eachHero.alpha = 0;
                        eachNameplate.alpha = 0;
                        let brawl = new createjs.Sprite(brawlSprite, "fight");
                        brawl.x = (pX.x * 100) - 10;
                        brawl.y = (pX.y * 100) - 6;
                        brawl.name = "b" + pOX;
                        stage.addChild(brawl);
                    } else {
                        eachHero.alpha = 1;
                        eachNameplate.alpha = 1;
                        if (stage.getChildByName("b" + pOX)) {
                            stage.removeChild(stage.getChildByName("b" + pOX));
                        }
                    }
                }

            });

            socket.on('invalidGame', function () {
                window.location.href = 'landing.html';
            });

            socket.on('gameTime', function (time) {
                document.getElementById("time").innerHTML = time;
            });
        }
    </script>
</body>

</html>