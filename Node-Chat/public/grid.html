<!doctype html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <title>Dokapon Heroes</title>

    <!-- Bootstrap core CSS -->
    <link href="../../assets/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://code.createjs.com/easeljs-0.8.2.min.js"></script>
    <script src="https://code.createjs.com/tweenjs-0.6.2.min.js"></script>
    <script src="https://code.createjs.com/preloadjs-0.6.2.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<!-- init checked if they are logged in, starts the loading animation, and starts the asset loading -->

<body onload="init();">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-10">
                <!-- battlefield is the stage -->
                <canvas id="battlefield" width="500"></canvas>
                <!-- x is a debugging panel -->
                <p id="x"></p>
                <!-- y is currently displaying the players eventually would like to move this to a left div panel -->
                <table id="y" style="border-spacing:10px;">
                    <tr></tr>
                </table>
                <!-- z is a debugging display -->
                <p id="z"></p>
            </div>
            <!-- displays turn, turn time, and exit button -->
            <div class="col-sm-2">
                Turn Timer:
                <p id="time"></p>
                Turn:
                <p id="turn"></p>
                <input id="btnReturn" type="button" class="btn btn-lg btn-primary" style="width:100%; white-space:normal;" onclick="landing()"
                    value="Return to Main Lobby">
            </div>
        </div>
        <!-- combat menu modal will display the user and then anyone he can attack -->
        <div id="mdlCombat" class="modal modal-fade modal-lg">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Combat Menu</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-4" id="mdlDefend" align="center"></div>
                            <div style="overflow-x: auto;white-space: nowrap;" class="container-fluid col-md-8">
                                <div class="row" id="mdlAttack">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var queue;
        var stage = new createjs.Stage("battlefield");
        var bfgridxy;
        var socket = io('/ingame');
        var players;
        var turnSelected = undefined;
        var playerLocation = new Object();
        var turnCount;

        // set the size of the stage, this should get nested in a div in case the stage gets massive
        function setbfgridxy(size) {
            bfgridxy = size;
            var canvas = document.getElementById("battlefield");
            if (size > 5) {
                canvas.height = (size * 100) + 20;
                canvas.width = (size * 100) + 20;
            } else {
                canvas.height = 520;
                canvas.width = 520;
            }
        }

        // returns the max x or y, this needs to be multipled by 100 to get grid coords
        function getbfgridxy() {
            return bfgridxy;
        }
        //creates a object to store player information, not currently updated fequently 
        function setPlayers(playerObject) {
            players = playerObject;
        }
        //returns player object
        function getPlayers() {
            return players;
        }
        //once the player has indicated they have loaded all of the assets, server will send the player information
        socket.on('gameJSON', function (gameJSON) {
            setbfgridxy(gameJSON.size);
            setPlayers(gameJSON.players);
        })
        //return to landing page
        function landing() {
            window.location.href = 'landing.html';
        }
        //run on body load, starts the loading of assets
        function init() {
            if (sessionStorage.id == undefined) {
                window.location.href = 'index.html';
                return false;
            }

            distractor();

            createjs.Ticker.setFPS(30);
            createjs.Ticker.on("tick", handleTick);

            queue = new createjs.LoadQueue(true);

            loadAsset();

            queue.on("complete", handleComplete);
            queue.on("error", handleError);
        }

        function handleError(event) {
            var item = event.data;
            var div = document.getElementById("z");
            if (div != null) {
                div.innerHTML = "<label>Error " + (item.id == "NoFileHere.png" ? ":)" : ":(") + "</label>";
                div.className = "gridBox error";
            }
        }

        function distractor() {
            var ldRect = new createjs.Shape();
            var ldCircle = new createjs.Shape();

            var ldText = new createjs.Text("Loading...", "bold 70px Arial", "#ff7700");
            ldText.x = 25;
            ldText.y = 50;

            ldRect.graphics.beginFill("#2b3e50").drawRect(0, 0, 500, 500);
            ldRect.x = 50;
            ldRect.y = 0;
            createjs.Tween.get(ldRect, {
                    loop: true
                })
                .to({
                    x: 400
                }, 3000, createjs.Ease.getPowInOut(4))
                .to({
                    x: 50
                }, 3000, createjs.Ease.getPowInOut(4));

            ldCircle.graphics.beginFill("Crimson").drawCircle(0, 0, 40);
            ldCircle.x = 50;
            ldCircle.y = 90;
            createjs.Tween.get(ldCircle, {
                    loop: true
                })
                .to({
                    x: 400
                }, 3000, createjs.Ease.getPowInOut(4))
                .to({
                    x: 50
                }, 3000, createjs.Ease.getPowInOut(4));

            stage.addChild(ldText);
            stage.addChild(ldRect);
            stage.addChild(ldCircle);
            stage.update();
        }

        function loadAsset() {
            queue.loadManifest([{
                id: "grass",
                src: "../../assets/img/grass.png"
            }, {
                id: "mightData",
                src: "../../assets/sprites/might.json",
                type: "spritesheet",
                crossOrigin: true
            }, {
                id: "magicData",
                src: "../../assets/sprites/magic.json",
                type: "spritesheet",
                crossOrigin: true
            }, {
                id: "cunningData",
                src: "../../assets/sprites/cunning.json",
                type: "spritesheet",
                crossOrigin: true
            }, {
                id: "brawlData",
                src: "../../assets/sprites/brawl.json",
                type: "spritesheet",
                crossOrigin: true
            }]);
        }

        function handleTick() {
            stage.update();
        }

        function handleComplete() {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[1]) {
                    socket.emit('gameID', pair[1], sessionStorage.id)
                }
            }
        }

        socket.on("allLoaded", function () {

            stage.removeAllChildren();

            createjs.Touch.enable(stage);
            stage.enableMouseOver(10);

            var grass = queue.getResult("grass");
            var mightSprite = queue.getResult("mightData");
            var magicSprite = queue.getResult("magicData");
            var cunningSprite = queue.getResult("cunningData");

            var bgContainer = new createjs.Container();
            var bgFill = new createjs.Shape();
            bgFill.graphics.beginBitmapFill(grass).drawRect(0, 0, getbfgridxy() * 100, getbfgridxy() * 100);
            bgContainer.addChild(bgFill);
            stage.addChild(bgContainer);

            // generates battlefield grid
            for (var y = 0; y < (getbfgridxy()); y++) {
                for (var x = 0; x < (getbfgridxy()); x++) {
                    var grid = new createjs.Shape();
                    grid.x = x * 100;
                    grid.y = y * 100;
                    grid.overStroke = "#00FF00";
                    grid.outStroke = "#3281FF";
                    grid.disableStroke = "#808080";
                    grid.clickStroke = "#000000";
                    grid.type = "grid";
                    grid.name = {
                        'x': x,
                        'y': y
                    };
                    grid.graphics.beginStroke(grid.disableStroke).setStrokeStyle(2).drawRect(
                        0, 0,
                        98, 98).endStroke();
                    var hit = new createjs.Shape();
                    hit.graphics.beginFill("#000").drawRect(0, 0, 100, 100);
                    grid.hitArea = hit;
                    stage.addChild(grid);
                }
            }

            for (var i = 0; i <= (getPlayers().length - 1); i++) {
                var heroData = getPlayers()[i];
                if (heroData.pClass != "Observer") {
                    var spriteSheet;
                    switch (heroData.pClass) {
                        case "Magii":
                            spriteSheet = magicSprite;
                            break;
                        case "Warrior":
                            spriteSheet = mightSprite;
                            break;
                        case "Rogue":
                            spriteSheet = cunningSprite;
                            break;
                    }
                    var hero = new createjs.Sprite(spriteSheet, "stand");
                    hero.x = (heroData.x * 100) + 50;
                    hero.y = (heroData.y * 100) + 95;
                    hero.type = "hero";
                    hero.name = heroData.pID;

                    playerLocation[heroData.pID] = {
                        x: heroData.x,
                        y: heroData.y
                    }

                    var nameplate = new createjs.Text(heroData.dName, "12px Arial", "#ff7700");
                    nameplate.x = (heroData.x * 100) + 25;
                    nameplate.y = (heroData.y * 100) + 100;
                    nameplate.name = "n" + heroData.pID;

                    stage.addChild(nameplate);
                    stage.addChild(hero);
                }

            }

            stage.update();

            var initJSON = {
                "playerID": sessionStorage.id,
                "turn": 0,
                "actionType": "init"
            }
            socket.emit('turnData', initJSON);
        });

        function handleGridEvent(event) {
            var target = event.target;
            if (event.type == "mouseover" && turnSelected == undefined) {
                target.graphics.beginStroke(target.overStroke).setStrokeStyle(2).drawRect(0, 0, 98, 98).endStroke();
            } else if (event.type == "mouseout" && turnSelected == undefined) {
                target.graphics.beginStroke(target.outStroke).setStrokeStyle(2).drawRect(0, 0, 98, 98).endStroke();
            } else if (event.type == "click" && turnSelected == undefined) {
                target.graphics.beginStroke(target.clickStroke).setStrokeStyle(2).drawRect(0, 0, 98, 98).endStroke();
                turnSelected = target;
                var turnJSON = {
                    "playerID": sessionStorage.id,
                    "stageX": event.stageX,
                    "actionType": "move",
                    "turn": turnCount,
                    "target": target.name
                }
                socket.emit('turnData', turnJSON);
            }
        }

        function handleDefendEvent(dAction) {
            let y = document.getElementById("mdlDefend");
            let x = y.getElementsByTagName("button");

            for (let i = 0; i <= x.length - 1; i++) {
                x[i].disabled = "disabled";
                //x[i].classList.add('disabled');
            }

            let turnJSON = {
                "playerID": sessionStorage.id,
                "actionType": "defend",
                "turn": turnCount,
                "dAction": dAction
            }
            socket.emit('turnData', turnJSON);
        }

        function handleAttackEvent(aAction, aID) {
            let y = document.getElementById("mdlAttack");
            let x = y.getElementsByTagName("button");

            for (let i = 0; i <= x.length - 1; i++) {
                x[i].disabled = "disabled";
                x[i].classList.add('disabled');
            }

            let turnJSON = {
                "playerID": sessionStorage.id,
                "actionType": "attack",
                "turn": turnCount,
                "advsID": aID,
                "aAction": aAction
            }
            socket.emit('turnData', turnJSON);
        }

        function movePlayer(PlayerTurnData) {
            let target = PlayerTurnData.target;
            if (turnSelected != undefined) {
                turnSelected.graphics.beginStroke(turnSelected.outStroke).setStrokeStyle(2).drawRect(
                    0,
                    0,
                    98, 98).endStroke();
                turnSelected = undefined;
            }
            let eachHero = stage.getChildByName(PlayerTurnData.playerID);
            let eachNameplate = stage.getChildByName("n" + PlayerTurnData.playerID);
            if (eachHero.x > PlayerTurnData.stageX) {
                eachHero.scaleX = -1;
                eachHero.gotoAndPlay("walk");
            } else {
                eachHero.gotoAndPlay("walk");
                eachHero.scaleX = 1;
            }

            createjs.Tween.get(eachHero, {
                    loop: false
                })
                .to({
                    x: (target.x * 100) + 50,
                    y: (target.y * 100) + 95
                }, 1000).call(function () {
                    eachHero.gotoAndPlay("stand");
                });

            createjs.Tween.get(eachNameplate, {
                loop: false
            }).to({
                x: (target.x * 100) + 25,
                y: (target.y * 100) + 100
            }, 1000)
        }

        function availableGrids(pLoc) {
            for (let i = 0; i <= stage.children.length - 1; i++) {
                let aChild = stage.getChildAt(i);
                if (aChild.type == "grid") {
                    if ((aChild.name.x == (pLoc.x + 1) && aChild.name.y == (pLoc.y)) || (aChild.name.x == (pLoc.x -
                            1) && aChild.name.y == (pLoc.y)) || (aChild.name.x == (pLoc.x) && aChild.name.y == (
                            pLoc.y + 1)) || (aChild.name.x == (pLoc.x) && aChild.name.y == (pLoc.y - 1))) {
                        aChild.graphics.beginStroke(aChild.outStroke).setStrokeStyle(2).drawRect(0, 0, 98,
                            98).endStroke();
                        aChild.on("mouseover", handleGridEvent);
                        aChild.on("mouseout", handleGridEvent);
                        aChild.on("click", handleGridEvent);
                    } else {
                        aChild.graphics.beginStroke(aChild.disableStroke).setStrokeStyle(2).drawRect(0, 0,
                            98, 98).endStroke();
                        aChild.removeAllEventListeners();
                    }
                }
            }
        }

        function disableGrids() {
            for (let i = 0; i <= stage.children.length - 1; i++) {
                let aChild = stage.getChildAt(i);
                if (aChild.type == "grid") {
                    let aChild = stage.getChildAt(i);
                    aChild.graphics.beginStroke(aChild.disableStroke).setStrokeStyle(2).drawRect(0, 0,
                        98, 98).endStroke();
                    aChild.removeAllEventListeners();
                }
            }
        }

        function mOpen() {
            document.getElementById('mdlCombat').style.display = "block";
        }

        function mClose() {
            document.getElementById('mdlCombat').style.display = "none";
        }

        function setAttack(advs) {
            var attackRow = document.getElementById("mdlAttack");
            var attackCol = document.createElement("div");

            var aLbl = document.createElement("p");
            var a1 = document.createElement("button");
            var a2 = document.createElement("button");
            var a3 = document.createElement("button");
            var a4 = document.createElement("button");
            var pad = document.createElement("p");

            attackCol.className = "col-md-4 text-center";
            attackCol.style = "display: inline-block;float: none;";
            aLbl.style = "word-wrap: break-word";
            a1.style = "margin-bottom:4px;white-space: normal;";
            a2.style = "margin-bottom:4px;white-space: normal;";
            a3.style = "margin-bottom:4px;white-space: normal;";
            a4.style = "margin-bottom:4px;white-space: normal;";
            a1.className = "btn-block btn-primary";
            a2.className = "btn-block btn-primary";
            a3.className = "btn-block btn-primary";
            a4.className = "btn-block btn-primary";

            aLbl.innerHTML = "<h3>" + advs.dName + "</h3>HP:" + advs.hp + "<br>Strength:" + advs.strength +
                "<br>Magic:" + advs.magic + "<br>Cunning:" + advs.cunning;
            a1.innerHTML = "Reckless Attack";
            a2.innerHTML = "Defensive Attack";
            a3.innerHTML = "Magic Missile";
            a4.innerHTML = "Retreat";

            a1.onclick = function () {
                handleAttackEvent(0, advs.pID);
            };
            a2.onclick = function () {
                handleAttackEvent(1, advs.pID);
            };
            a3.onclick = function () {
                handleAttackEvent(2, advs.pID);
            };
            a4.onclick = function () {
                handleAttackEvent(3, advs.pID);
            };

            attackCol.appendChild(aLbl);
            attackCol.appendChild(a1);
            attackCol.appendChild(a2);
            attackCol.appendChild(a3);
            attackCol.appendChild(a4);
            attackCol.appendChild(pad);
            attackRow.appendChild(attackCol);
        }

        function setDefend(p) {
            var defendPanel = document.getElementById("mdlDefend");

            defendPanel.innerHTML = "";

            var dLbl = document.createElement("p");
            var d1 = document.createElement("button");
            var d2 = document.createElement("button");
            var d3 = document.createElement("button");
            var d4 = document.createElement("button");

            dLbl.style = "word-wrap: break-word";
            d1.style = "margin-bottom:4px;white-space: normal;";
            d2.style = "margin-bottom:4px;white-space: normal;";
            d3.style = "margin-bottom:4px;white-space: normal;";
            d4.style = "margin-bottom:4px;white-space: normal;";
            d1.className = "btn-block btn-primary";
            d2.className = "btn-block btn-primary";
            d3.className = "btn-block btn-primary";
            d4.className = "btn-block btn-primary";

            dLbl.innerHTML = "<h3>Defensive Action</h3>" + p.cardinal + "<br>HP:" + p.hp + "<br>Strength:" + p.strength +
                "<br>Magic:" + p.magic + "<br>Cunning:" + p.cunning;
            d1.innerHTML = "Counter Attack";
            d2.innerHTML = "Block";
            d3.innerHTML = "Resist";
            d4.innerHTML = "Focus";

            d1.onclick = function () {
                handleDefendEvent(0);
            };
            d2.onclick = function () {
                handleDefendEvent(1);
            };
            d3.onclick = function () {
                handleDefendEvent(2);
            };
            d4.onclick = function () {
                handleDefendEvent(3);
            };

            defendPanel.appendChild(dLbl);
            defendPanel.appendChild(d1);
            defendPanel.appendChild(d2);
            defendPanel.appendChild(d3);
            defendPanel.appendChild(d4);

        }

        socket.on("attack", function (combat) {
            document.getElementById("z").innerHTML += combat + "<br>";
        });

        socket.on("brawlin", function (pX, target) {
            if (!stage.getChildByName("b" + pX)) {
                var brawlSprite = queue.getResult("brawlData");
                let eachHero = stage.getChildByName(pX);
                let eachNameplate = stage.getChildByName("n" + pX);
                let brawl = new createjs.Sprite(brawlSprite, "fight");

                eachHero.alpha = 0;
                eachNameplate.alpha = 0;

                brawl.x = (target.x * 100) - 10;
                brawl.y = (target.y * 100) - 6;
                brawl.name = "b" + pX;
                stage.addChild(brawl);
            }
            if (pX == sessionStorage.id) {
                mOpen();
            }
        });

        socket.on("move", function (moveData) {
            for (let i = 0; i <= (moveData.length - 1); i++) {
                movePlayer(moveData[i]);
            };
        });

        socket.on("setTurn", function (iTurnCount, grid) {
            document.getElementById("mdlAttack").innerHTML = "";

            turnCount = iTurnCount;
            document.getElementById("turn").innerHTML = turnCount;
            var x = document.getElementById("y");
            x.deleteRow(0);
            var row = x.insertRow(0);

            for (let i = 0; i <= (grid.length - 1); i++) {
                let cell = row.insertCell(i);
                if (grid[i].playerID == sessionStorage.id) {
                    cell.style.color = "#ffa500";
                    if (grid[i].inCombat.length == 0) {
                        availableGrids(grid[i].target);
                    } else {
                        let advs = grid[i].inCombat;

                        disableGrids();
                        for (let i = 0; i <= (advs.length - 1); i++) {
                            setAttack(advs[i]);
                        };
                        setDefend(grid[i]);
                    }
                    if (grid[i].isDead == true) {
                        disableGrids();
                    }
                };
                if (grid[i].isDead == true) {
                    cell.innerHTML = grid[i].dName + "<br>Dead";
                } else {
                    cell.innerHTML = grid[i].dName + "<br>" + grid[i].hp;
                }

            };
        });

        socket.on('invalidGame', function () {
            window.location.href = 'landing.html';
        });

        socket.on('gameTime', function (time) {
            document.getElementById("time").innerHTML = time;
            if (time === 0) {
                mClose();
            }
        });

        socket.on('result', function (strResult) {
            let text = new createjs.Text(strResult, "bold 86px Arial", "#ff7700");
            text.x = 100;
            text.y = 0;

            stage.addChild(text);

            createjs.Tween.get(text, {
                    loop: false
                })
                .to({
                    y: 200
                }, 2000, createjs.Ease.getPowInOut(4));
        });
    </script>
</body>

</html>